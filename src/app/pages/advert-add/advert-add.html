<h4 class="h4 fw-600 mb-24">Новое объявление</h4>

<form [formGroup]="advertAddForm" (ngSubmit)="onSubmit()" class="advert-add-form base mb-48">
    @if (categories()) {
        <div>
            <label for="category">Выберите категорию <span class="required">*</span></label>
            <div class="middle-field">
                <p-cascadeselect
                    formControlName="category"
                    [options]="categories()"
                    optionLabel="name"
                    [optionValue]="'id'"
                    optionGroupLabel="name"
                    [optionGroupChildren]="['childs']"
                    placeholder="Нажмите, чтобы выбрать"
                    [invalid]="isControlInvalid('category')"
                />
                <app-control-error
                    [form]="advertAddForm"
                    controlName="category"
                    [isShow]="isSubmitted()"
                ></app-control-error>
            </div>
        </div>
    }
    <div>
        <label for="title">Название объявления <span class="required">*</span></label>
        <div>
            <input
                pInputText
                formControlName="title"
                placeholder="Что хотите продать?"
                autocomplete="off"
                [invalid]="isControlInvalid('title')"
            />
            <app-control-error
                [form]="advertAddForm"
                controlName="title"
                [isShow]="isSubmitted()"
            ></app-control-error>
        </div>
    </div>
    <div>
        <label for="description">Описание</label>
        <div>
            <textarea
                pTextarea
                formControlName="description"
                placeholder="Расскажите подробнее о товаре или услуге"
                autoResize="true"
                style="resize: none"
                [invalid]="isControlInvalid('description')"
                class="big-field mb--5"
            ></textarea>
            <app-control-error
                [form]="advertAddForm"
                controlName="description"
                [isShow]="isSubmitted()"
            ></app-control-error>
        </div>
    </div>
    <div class="advert-add__address">
        <label for="address">Адрес (место проведения сделки) <span class="required">*</span></label>
        @if (currentUser()) {
            @if (userAddress()) {
                <div class="advert-add__address-saved">
                    <button
                        pButton
                        type="button"
                        [rounded]="true"
                        severity="secondary"
                        class="advert-add__address-label"
                        [disabled]="!isAddressInputVisible()"
                        (click)="addAddressToForm()"
                    >
                        <span pButtonIcon class="pi pi-home"></span>
                        <span pButtonLabel>{{ currentUser()?.address }}</span>
                    </button>
                    <button
                        pButton
                        text
                        type="button"
                        severity="secondary"
                        icon="pi pi-pen-to-square"
                        [title]="isAddressInputVisible() ? 'Скрыть адрес' : 'Изменить адрес'"
                        class="advert-add__address-change-btn"
                        (click)="addressInputToggle()"
                    ></button>
                    <button
                        pButton
                        text
                        type="button"
                        severity="secondary"
                        icon="pi pi-times"
                        title="Удалить адрес"
                        class="advert-add__address-change-btn"
                        (click)="addressDelete()"
                    ></button>
                </div>
            }
            @if (isAddressInputVisible() || !userAddress()) {
                <div class="advert-add__address-input-wrapper">
                    <div class="advert-add__address-input">
                        <app-address-input
                            formControlName="address"
                            [invalid]="isControlInvalid('address')"
                            (keydown.enter)="addressUpdate()"
                            (keydown.esc)="addressInputToggle()"
                        ></app-address-input>
                        <button
                            pButton
                            type="button"
                            label="Сохранить адрес"
                            icon="pi pi-save"
                            severity="secondary"
                            [disabled]="isAddressInputEmpty() || isAddressInputSame()"
                            class="advert-add__address-save-btn"
                            (click)="addressUpdate()"
                        ></button>
                    </div>
                    <app-control-error
                        [form]="advertAddForm"
                        controlName="address"
                        [isShow]="isSubmitted()"
                    ></app-control-error>
                </div>
            }
        } @else {
            <app-spinner type="address-input"></app-spinner>
        }
    </div>
    <app-images-upload
        [(uploadImages)]="uploadImages"
        class="advert-add-form__upload"
    ></app-images-upload>
    <div>
        <label for="price">Цена <span class="required">*</span></label>
        <div class="small-field">
            <p-inputnumber
                formControlName="price"
                placeholder="0 ₽"
                mode="currency"
                currency="RUB"
                currencyDisplay="symbol"
                locale="ru-RU"
                [minFractionDigits]="0"
                autocomplete="off"
                inputStyleClass="add"
                [invalid]="isControlInvalid('price')"
            />
            <app-control-error
                [form]="advertAddForm"
                controlName="price"
                [isShow]="isSubmitted()"
            ></app-control-error>
        </div>
    </div>
    <div>
        <label for="phone">Номер телефона <span class="required">*</span></label>
        <div class="small-field">
            <p-inputMask
                formControlName="phone"
                type="phone"
                mask="+7 (999) 999 99 99"
                placeholder="+7 (999) 999 99 99"
                autocomplete="phone"
                [invalid]="isControlInvalid('phone')"
            ></p-inputMask>
            <app-control-error
                [form]="advertAddForm"
                controlName="phone"
                [isShow]="isSubmitted()"
            ></app-control-error>
        </div>
    </div>
    <div>
        <label for="email">E-mail</label>
        <div class="small-field">
            <input
                pInputText
                type="email"
                formControlName="email"
                placeholder="Адрес электронной почты"
                autocomplete="email"
                [invalid]="isControlInvalid('email')"
            />
            <app-control-error
                [form]="advertAddForm"
                controlName="email"
                [isShow]="isSubmitted()"
            ></app-control-error>
        </div>
    </div>
    <div class="two-fields">
        <button
            pButton
            type="submit"
            [label]="isLoading() ? 'Размещаем объявление' : 'Разместить объявление'"
            [loading]="isLoading()"
            [disabled]="!isAllRequiredCompleted() || (isSubmitted() && advertAddForm.invalid)"
            class="advert-add-form__btn mt-8"
        ></button>
        <button
            pButton
            severity="secondary"
            type="button"
            class="advert-add-form__btn mt-8"
            [disabled]="isCleanForm()"
            (click)="onResetFormData()"
        >
            <span pButtonLabel>Очистить форму</span>
        </button>
        <app-form-message
            [(success)]="successMessage"
            [(error)]="errorMessage"
            [lifeSuccess]="800"
        ></app-form-message>
    </div>
    <div class="advert-add__submit-disclaimer small-field sm">
        <p>Нажимая кнопку «Разместить объявление»</p>
        <p>
            Вы соглашаетесь с <span (click)="openTermsOfServiceDialog()">правилами площадки</span>
        </p>
    </div>
</form>
