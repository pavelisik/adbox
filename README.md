# ADBOX - доска объявлений

Веб-приложение на Angular для просмотра и размещения объявлений. Реализована возможность авторизации и регистрации пользователей, изменения настроек пользователей.

## Установка и запуск проекта

1. Клонируйте репозиторий:

```bash
git clone https://github.com/pavelisik/adbox.git
```

2. Перейдите в директорию проекта:

```bash
cd adbox
```

3. Установите зависимости:

```bash
npm install
```

4. Запустите проект в режиме разработки:

```bash
npm start
```

5. Откройте приложение в браузере по адресу:

```
http://localhost:4200
```

## Структура проекта

Директория **core** - низкоуровневые сущности, необходимые для работы всего приложения:

- `auth` - необходимые для авторизации сервисы и интерфейсы доменов авторизации:
    - `auth.service` - общий сервис для авторизации, разлогинивания и подтверждения пароля;
    - `auth.state.service` - сервис состояния авторизации, работа с токеном авторизации, синхронизация с cookie;
    - `local-user.service` - сервис для локальных данных пользователя, синхронизация с cookie;
    - `local-user.store.service` - сервис, хранящий локальные данные пользователя;
    - `users.facade` - фасад для оркестрации серверных и локальных данных пользователя;
    - `users.service` - сервис для api-взаимодействий пользователей;
    - `users.store.service` - сервис, хранящий серверные данные пользователя.
- `confirmation`
    - `confirmation.service` - сервис, формирующий confirm-сообщения;
    - `password-confirmation.service` - сервис для работы логики подтверждения пароля.
- `dialog`
    - `dialog.service` - сервис для работы с диалоговыми окнами.
- `guards` - защитники навигации:
    - `auth.guard` - защитник для авторизованных и неавторизованных пользователей;
    - `redirect-my-user.guard` - защитник для редиректа на страницу с объявлениями текущего пользователя.
- `interceptors` - перехватчики запросов:
    - `constants`
        - `error-messages` - словарь ошибок сервера в соответствии с проектом;
        - `error-titles.enum` - стандартные заголовки ошибок в зависимости от статуса запроса.
    - `utils`
        - `format-error-response.util` - форматирование информации серверной ошибки для вывода.
    - `auth.interceptor` - перехватчик запросов для авторизованных пользователей с добавлением токена авторизации;
    - `errors.interceptor` - перехватчик запросов для вывода toast-сообщений об ошибках;
    - `images-cache.interceptor` - перехватчик GET-запросов для кэширования полученных Blob-изображений.
- `notification`
    - `notification.service` - сервис, формирующий toast-сообщения.

Директория **infrastructure** - сервисы для работы с API, интерфейсы DTO и адаптеры преобразования интерфейсов из DTO в бизнес-домены:

- `advert` - объявления;
- `authorization` - авторизация;
- `categories` - категории;
- `comment` - комментарии;
- `images` - изображения для объявлений;
- `users` - пользователи.

Директория **pages** - компоненты отдельных страниц с интерфейсами бизнес-доменов:

- `advert` - страница отображения объявления по его id;
- `advert-add` - страница с формой добавления нового объявления;
- `advert-edit` - страница с формой редактирования объявления;
- `adverts-list` - страница со списком всех объявлений: условно отображает объявления на главной странице, результаты поиска с различными фильтрами, объявления конкретного пользователя и объявления авторизованного пользователя;
- `not-found` - страница для неопознанных адресов;
- `settings` - страница с формами изменения настроек и смены пароля авторизованного пользователя.

Директория **shared** - универсальные компоненты бизнес-логики, диалоговые окна, layout-компоненты, директивы, пайпы, универсальные сервисы бизнес-логики:

- `components` - все универсальные компоненты:
    - `ad-grid` - универсальный компонент для вывода сетки объявлений;
        - `ad-grid-item` - компонент для вывода карточки одного объявления в сетке;
            - `image` - компонент для вывода превью изображения для карточки одного объявления;
    - `ad-sidebar-filters` - компонент для вывода сайдбара с фильтрами на странице с результатами поиска;
    - `ad-title` - компонент для вывода заголовка страницы с объявлениями;
    - `ad-top-filters` - компонент для вывода верхней панели фильтров на странице с результатами поиска;
        - `picked-filters` - компонент для вывода всех выбранных фильтров с возможностью их удаления;
    - `breadcrumbs` - компонент для вывода хлебных крошек;
    - `forms` - папка с компонентами, необходимых для форм:
        - `control-error` - компонент для вывода ошибок для FormControls;
        - `password-input` - компонент, формирующий текстовое поле для ввода пароля;
        - `form-message` - компонент для вывода сообщений об ошибках формы и сообщений об удачных запросах формы;
        - `images-upload` - компонент для загрузки и предварительного просмотра изображений для объявления.
    - `image-gallery` - компонент для вывода галереи изображений на странице объявления;
    - `search-bar` - компонент для вывода верхней панели с формой поиска объявлений и фильтром категорий;
        - `category-menu` - компонент для вывода меню с фильтром категорий;
    - `spinner` - компонент для отображения большого спиннера во время загрузки.
    - `svg-icon` - компонент-обертка для svg-иконок.
    - `top-bar` - компонент для вывода верхней панели с пользовательским меню.

- `dialogs` - компоненты диалоговых окон:
    - `dialog-container` - контейнер-компонент для всех диалоговых окон;
    - `info-dialog` - компонент для вывода простого диалогового окна с информацией;
    - `login-dialog` - компонент для вывода диалогового окна авторизации пользователя;
    - `password-dialog` - компонент для подтверждения пароля пользователя;
    - `register-dialog` - компонент для вывода диалогового окна регистрации нового пользователя;
    - `terms-of-service` - компонент с информацией о правилах пользования приложением.

- `directives` - директивы:
    - `dnd.directive` - директива для drag and drop зоны в загрузчике изображений.

- `layouts` - переиспользуемые layout-компоненты:
    - `header` - компонент для вывода шапки;
    - `main-layout` - основной компонент для всех страниц.

- `pipes` - вспомогательные пайпы:
    - `adverts-count.pipe` - пайп для вывода числа объявлений с правильным склонением;
    - `date-format.pipe` - пайп для форматирования даты объявления;
    - `image-from-id.pipe` - асинхронный пайп для получения Blob-изображения по переданному id изображения;
    - `images-from-ids.pipe` - асинхронный пайп для получения массива Blob-изображений по переданному массиву id изображений (для галереи);
    - `phone-format.pipe` - пайп для форматирования телефонного номера;
    - `price-format.pipe` - пайп для форматирования цены.

- `services` - все сервисы, необходимые для работы страниц, компонентов, диалоговых окон:
    - `advert-draft.state.service` - сервис для работы с состоянием черновика объявления;
    - `advert.service` - сервис для работы с объявлениями;
    - `breadcrumbs.service` - сервис для формирования хлебных крошек;
    - `category.facade` - фасад для для работы с категориями;
    - `category.service` - сервис для api-взаимодействий с категориями;
    - `category.store.service` - сервис для хранения всех категорий;
    - `image.service` - сервис для работы с изображениями.

- `utils` - утилитарные вспомогательные функции:
    - `categories-transform.util` - преобразует массив категорий в дерево с вложенными childs;
    - `data-url-to-file.util` - преобразует строку Data URL в объект File;
    - `find-category-from-id.util` - поиск категории по id в модифицированном древовидном массиве.

- `validators` - кастомные валидаторы:
    - `passwordsMatch.validator` - валидирует совпадение двух паролей.

## Тестирование

В проекте реализованы unit-тесты с использованием Jasmine и Angular TestBed.

Запуск unit-тестов:

```bash
npm test
```

### Структура тестов для компонента Advert

- **Инициализация и базовые методы**
    - компонент создается;
    - `ngOnInit()` вызывает `advertService.getAdvert` и устанавливает сигнал `advert`;
    - проверка метода `isMyAdvert()`;
    - проверка метода `isAuth()` через `AuthStateService`.

- **Интерактивные методы**
    - `infoDialogOpen()` вызывает `dialogService.open` с правильными параметрами.

- **Удаление объявления**
    - успешное удаление через `ConfirmService` и `AdvertService`;
    - обработка ошибок при удалении объявления;
    - не вызывает `ConfirmService`, если `advertId` отсутствует.

### Структура тестов для сервиса AuthState

- **Общие тесты и состояние авторизации**
    - сервис создаётся;
    - `isAuth()` возвращает `false`, если токена нет;
    - `isAuth()` возвращает `true` после сохранения токена.

- **Сохранение и удаление токена**
    - `saveToken(token, true)` сохраняет токен и устанавливает cookie с 30-дневным сроком;
    - `saveToken(token, false)` сохраняет токен и устанавливает cookie без срока;
    - `deleteToken()` очищает токен и удаляет cookie.

- **Логика редиректа после авторизации**
    - `setRedirectUrl()` и `clearRedirectUrl()` корректно сохраняют и очищают URL;
    - `redirectAfterLogin()` навигирует по redirectUrl и очищает его;
    - `redirectAfterLogin()` ничего не делает, если redirectUrl пустой.

### Структура тестов для пайпа DateFormat

- **Общие тесты**
    - пайп создаётся;
    - корректно парсит строковое значение даты.

- **Форматирование для разных случаев**
    - для сегодняшней даты возвращает `Сегодня HH:MM`;
    - для вчерашней даты возвращает `Вчера HH:MM`;
    - для старых дат возвращает дату в полном формате: `день, месяц, время`;
    - пограничные случаи: различает вчерашнюю 23:59 и сегодняшнюю 00:01.
